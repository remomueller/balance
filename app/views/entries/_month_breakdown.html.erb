<% @first_sunday = @start_date - @start_date.wday.day %>
<% @last_saturday = @end_date + (6 - @end_date.wday).day %>
<% @entries = current_user.entries.with_date_for_calendar(@start_date, @end_date) %>

<% gross_spending = @entries.select{|e| e.charge_type.counts_towards_spending?}.sum{|e| e.amount} %>
<% gross_income = @entries.select{|e| not e.charge_type.counts_towards_spending?}.sum{|e| e.amount} %>
<% net_profit = gross_income - gross_spending %>

<div style="float:right;text-align:right;margin-top:-70px">
  <b>Gross Income</b> <%= gross_income.to_currency %><br />
  <b>Spending</b> <%= gross_spending.to_currency %><br />
  <b>Net <%= (net_profit < 0) ? "<span class='loss'>Loss</span>".html_safe : "<span class='gain'>Profit</span>".html_safe %></b> <span class="<%= (net_profit < 0) ? 'loss' : '' %><%= (net_profit > 0) ? 'gain' : '' %>"><%= net_profit.to_currency %></span>
</div>

<table style="width:100%;border-collapse:collapse;table-layout: fixed;border: 1px solid #ddd"><%#= '<col width="14%"/>'*7 %>
  <thead>
    <tr style="border: 1px solid #ddd">
      <% (0..6).each do |iDay| %>
        <th><%= Date::ABBR_DAYNAMES[iDay] %></th>
      <% end %>
    </tr>
  </thead>
  <tbody style="font-size:11px">
    <tr>
      <% (0..@last_saturday - @first_sunday).each do |first_day_offset| %>
        <% iDate = @first_sunday + first_day_offset.day %>
        <td valign="top" style="padding:0px;border: 1px solid #ddd"
            class="<%= 'calendar-entry-body-today' if iDate == Date.today %>
                   <%= 'last-month' if iDate < @start_date %>
                   <%= 'next-month' if iDate > @end_date %> day_droppable"
            data-billing-date="<%= iDate.strftime("%m/%d/%Y") %>"
            onmouseover="$('#calendar_box_<%= first_day_offset %>_new_entry_link').show();"
            onmouseout="$('#calendar_box_<%= first_day_offset %>_new_entry_link').hide();"
            ondblclick="openCalendarPopup('<%= iDate.strftime('%m/%d/%Y') %>');">
          <div style="width:100%">
            <div class="calendar-entry-heading">
              <%= link_to image_tag('001_46.png', style: 'border:none;vertical-align:text-bottom', size: '11x11', title: "New Entry for #{iDate.strftime("%B %e, %Y")}"), new_entry_path(entry: {billing_date: iDate}, from_calendar: 1), style: 'display:none', id: "calendar_box_#{first_day_offset}_new_entry_link" %>
              <% if [@start_date, (@end_date + 1.day)].include?(iDate) %>
                <%= iDate.strftime("%b %e") %>
              <% else %>
                <%= iDate.strftime("%e") %>
              <% end %>
            </div>
            <div style="min-height:60px" data-object="day-body" data-date="<%= iDate.strftime("%m/%d/%Y") %>">
              <%= render partial: 'calendar_day_body', locals: { iDate: iDate } %>
            </div>
          </div>
        </td>
        <%= "</tr><tr>".html_safe if first_day_offset % 7 == 6 and first_day_offset != @last_saturday - @first_sunday %>
      <% end %>
    </tr>
  </tbody>
</table>
